<h1 class="settings-section-title">Settings <span><img src="/common/icons/settings.svg" width="50" height="50"></span></h1>
<details>
    <summary class="settings-section-title">
        Themes <span><img src="/common/icons/themes.svg" width="50" height="50"></span>
    </summary>
    <div class="themelist"></div>
</details>
<br>
<details>
    <summary class="settings-section-title">
        General <span><img src="/common/icons/settings.svg" width="50" height="50"></span>
    </summary>
    <div class="experiments">
        <div class="experiment">
            <label for="no_ask_to_delete">Don't ask to delete Tiles</label>
            <input type="checkbox" id="no_ask_to_delete" />
        </div>
        <div class="experiment">
            <label for="uis">UI Sounds</label>
            <input type="checkbox" id="uis" />
        </div>
        <div class="experiment">
            <label for="cpm">Center Mode <span class="tag-beta">BETA</span></label>
            <input type="checkbox" id="cpm" />
        </div>
    </div>
</details>
<br>
<details>
    <summary class="settings-section-title">
        Experiments <span><img src="/common/icons/experi.svg" width="50" height="50"></span>     
    </summary>
    <div class="experiments">
        <div class="experiment">
            <label for="blvs">Skip Splash Animation <span class="tag-beta">BETA</span></label>
            <input type="checkbox" id="blvs" />
        </div>
        <div class="experiment">
            <label for="nbik">No preset keys (Stop All,Reload,Logo) <span class="tag-beta">BETA</span></label>
            <input type="checkbox" id="nbik" />
        </div>
        <div class="experiment">
            <label for="swc">Show Recompile as a Sidebar tab</label>
            <input type="checkbox" id="swc" />
        </div>
        <div class="experiment">
            <label for="apc">Animate Page Changes <span class="tag-beta">BAD</span></label>
            <input type="checkbox" id="apc" />
        </div>
    </div>
</details>
<br>
<details class="experiment-exist soundpack">
    <summary class="settings-section-title">
        UI Sounds <span><img src="/common/icons/uisounds.svg" width="50" height="50"></span>
    </summary>
    <div>
        <h4>Soundpacks</h4>
        <ul class="soundpacks"></ul>
        <h2>Current Soundpack</h2>
        <div class="experiment-exist">
            <h3 id="soundpack-title">Soundpack</h3>
            <span>(<span id="soundpack-id">id.soundpack</span>)
                v<span id="soundpack-version">0.0.0</span> by
                <span id="soundpack-author">somebody</span></span>
        </div>
        <ul class="uisounds"></ul>
    </div>
</details>
<br>
<details>
    <summary class="settings-section-title">
        Bug Report <span><img src="/common/icons/bugs.svg" width="50" height="50"></span>
    </summary>
    <textarea name="bgrep" id="bgrep">Click "Generate Report"</textarea>
    <br>
    <button id="genr">Generate Report</button>
    <details>
        <summary>
            Report Reader
        </summary>
        <textarea name="input-bgrep" id="input-bgrep" class="input-bgrep"></textarea>
        <button id="read-bgrep">Read Report</button>
        <div class="report-details">

        </div>
    </details>

</details>
<style>
    details > summary::marker {
        display: none;
        content: "";
    }
    details > summary:hover {
        cursor: pointer;
    }
    .experiments {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .experiment {
        display: flex;
        background: var(--modal-item-bg);
        background-size: var(--modal-item-bg-size);
        animation: var(--modal-item-bg-anim);
        padding: 0.65rem;
        border-radius: var(--tile-radius);
    }

    .experiment input {
        width: 50%;
    }

    .uisounds,
    .soundpacks {
        display: flex;
        flex-wrap: wrap;
        gap: .25rem;
    }

    .uisounds li,
    .soundpacks li {
        display: flex;
        gap: .25rem;
        background: var(--modal-item-bg);
        background-size: var(--modal-item-bg-size);
        animation: var(--modal-item-bg-anim);
        padding: .5rem;
        border-radius: 1.5rem;
    }

    .experiment-exist h3 {
        margin: 0;
    }

    .experiment-exist {
        background-color: rgba(0, 0, 0, 0.25);
        padding: 5px;
        border-radius: 1.5rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: start;
    }

    .cti {
        display: flex;
        flex-direction: row;
        align-items: center;
        justify-content: center;
        position: fixed;
        bottom: 0;
        left: calc(
            50% - 50vw
        )
        transform: translateX(-50%);
        background-color: rgba(0, 0, 0, 0.25);
        width: max-content;
        padding: 5px;
        border-radius: 1.5rem 1.5rem 0 0;

    }

    .ctxl,
    .flags {
        display: flex;
        flex-wrap: wrap;
    }
</style>
<br>
<div class="settings"></div>
<details>
    <summary class="settings-section-title">
        Developer Tools <span><img src="/common/icons/dev.svg" width="50" height="50"></span>
    </summary>
    <div class="flex-wrap-r">
        <button onclick="universal.save('thanks', '\x9EÃ©e');window.location.reload()">
            Show changelog (Reloads)
        </button>
        <button onclick="universal.showBootLog()">
            Show boot log
        </button>
        <button onclick="universal.sendToast('This is a test', 'Settings')">
            Test Notification
        </button>
        <button onclick="universal.send(universal.events.default.recompile)">
            Ask server to recompile Webpack bundles
        </button>
    </div>
    <br>
    <details>
        <summary>
            freedeck:// URI Utilities
        </summary>
        <p>Prefix is freedeck://COMMAND/ARGS</p>
        <div class="flex-wrap-r">
            <button onclick="window.location.href='freedeck://startup'">
                startup
            </button>
            <button onclick="window.location.href='freedeck://show'">
                show
            </button>
            <button onclick="window.location.href='freedeck://hide'">
                hide
            </button>
            <button onclick="window.location.href='freedeck://show/front'">
                show/front
            </button>
        </div>
        <h3>App Utilities - Plugin Management</h3>
        <div class="flex-wrap-r">
            <div><h3>Download Flow</h3>
                <p>://download/ID/URL/DESCRIPTION/REPO_TITLE</p></div>
                <br>
            <button onclick="window.location.href='freedeck://download/ID/URL/DESCRIPTION/REPO_TITLE'">
                Download Flow
            </button>
            <br>
            <div><h3>Update Flow</h3>
                <p>://update/ID/URL/DESCRIPTION/REPO_TITLE/FROM_V0/TO_V1</p></div>
                <br>
            <button onclick="window.location.href='freedeck://update/ID/URL/DESCRIPTION/REPO_TITLE/FROM_V0/TO_V1'">
                Update Flow
            </button>
        </div>
    </details>
    <br>
    <strong><a href="//github.com/ia74/contextual" target="_blank">Contextual</a></strong>
    <br>
    <div class="ctxl"></div>
    <p id="ctx"></p>
    <h3>Be warned, you can reset your data from here. Tile configuration is NOT affected.</h3>
    <strong>Flags</strong>
    <div class="flags"></div>
    <strong>Cfg</strong>
    <div>
        <button id="fsw">Force setup-wizard</button>
        <details>
            <summary>Erase ALL LocalStorage data</summary>
            <button id="erals">ERASE! (NO UNDOING, WILL HAPPEN ON CLICK.)</button>
        </details>
    </div>
</details>
<br><br>
<div class="cti">
    <h1>Freedeck</h1>
    <img src="/common/icons/fd.png" alt="Freedeck Logo" width="75" height="75">
    <p>is a project by <a href="https://aidens.dev" target="_blank">ia74 / Aiden S.</a></p>
</div>
<!-- <h2>This is the bottom of the Settings menu.</h2> -->
<script type="module">
    import "/app/settingsThemes.js";
    st_ldt();

    b("#fsw").onclick = () => {
        universal.save("has_setup", false);
        window.location.reload();
    }

    b("#genr").onclick = () => {
        const bgrep = b("#bgrep");
        const report = bgrep.value;
        bgrep.value = "Generating report...";
        const rep = universal.ExportReportData();
        bgrep.value = rep;
    }

    b("#read-bgrep").onclick = () => {
        const input = b("#input-bgrep");
        const report = input.value;
        const details = b(".report-details");
        details.innerHTML = "";
        const data = JSON.parse(report);
        appendDetails(details, data);
    }

    function appendDetails(parent, data) {
        Object.keys(data).forEach((key) => {
            const detail = document.createElement("details");
            const summary = document.createElement("summary");
            summary.innerText = key;
            detail.appendChild(summary);

            if (typeof data[key] === "object" && data[key] !== null) {
                appendDetails(detail, data[key]);
            } else {
                const p = document.createElement("p");
                p.innerText = key + ": " + data[key];
                detail.appendChild(p);
            }

            parent.appendChild(detail);
        });
    }



    function b(s) { return document.querySelector(s) }

    function settingsViewMakeFlagButton(flag, name) {
        const button = document.createElement("button");
        button.innerText = name;
        button.onclick = () => {
            universal.save(flag, false);
            universal.sendToast("Flag " + flag + " reset!");
        };
        return button;
    }
    function settingsViewOpen(view, name) {
        const button = document.createElement("button");
        button.innerText = name;
        button.onclick = () => {
            universal.vopen(view);
        };
        return button;
    }

    document.querySelector("#ctx").innerText = JSON.stringify(universal.ctx);
    const _flags = [
        settingsViewMakeFlagButton("has_setup", "set flag has_setup to false")
    ]

    for (const flag of _flags) document.querySelector(".flags").appendChild(flag);

    const _views = [
    ];
    for(const view of universal.ctx.views) {
        const button = settingsViewOpen(view, view);
        _views.push(button);
    }
    for (const view of _views) document.querySelector(".ctxl").appendChild(view);

    const setToLocalCfg = (key, value) => {
        const cfg = universal.lclCfg();
        cfg[key] = value;
        return cfg;
    }

    window.settingsView_set = (k, v) => {
        universal.send(
            universal.events.default.config_changed,
            setToLocalCfg(k, v)
        );
    }

    window.settingsView_check = (k, v, a = () => { }) => {
        document.querySelector(k).checked = universal.load(v) == "true";
        document.querySelector(k).onchange = (ev) => {
            universal.save(v, !(universal.load(v) == "true"));
            a(ev);
        }
    }
    window.settingsView_lcCheck = (k, v) => {
        document.querySelector(k).checked = universal.lclCfg()[v] == true;

        document.querySelector(k).onchange = () => {
            window.settingsView_set(v, !(universal.lclCfg()[v] == true));
        };
    }

    window.settingsView_createLSCheck = (id, label, description, changed) => {
        const a = "";
        window.settingsView_check("#" + id, id, changed);
    }

    window.settingsView_check("#swc", "swc", () => { universal.reloadRight() });
    window.settingsView_check("#blvs", "skipanim");

    window.settingsView_lcCheck("#nbik", "nopreset")
    window.settingsView_lcCheck("#cpm", "center")
    window.settingsView_check("#no_ask_to_delete", "no_ask_to_delete")
    window.settingsView_lcCheck("#apc", "animation")

    document.querySelector("#uis").checked = universal.uiSounds.enabled();
    document.querySelector("#uis").onchange = () => {
        universal.save("uiSounds", !universal.uiSounds.enabled());
        document.querySelector(".soundpack").style.display = universal.uiSounds
            .enabled()
            ? "block"
            : "none";
    };

    document.querySelector("#erals").onclick = () => {
        localStorage.clear();
        universal.sendToast("Erased all LocalStorage data! Cleaning up...", "Settings: Developer Tools");
        window.location.reload();
    }

    /**
     * Create a setting dynamically.
     * @param {*} name The name of the setting.
     * @param {*} id The ID of the setting.
     * @param {*} value The option setter.
     * @param {*} onLoad The default value.
     * @param {*} goto The CSS selector to append to.
     * @param {*} onChanged The function to call when the setting changes.
     */
    function createBooleanSetting(
        name,
        id,
        value,
        onLoad,
        goto,
        onChanged = () => { },
    ) {
        const div = document.createElement("div");
        div.className = "flex-wrap-r";
        const p = document.createElement("p");
        p.innerText = name;
        const input = document.createElement("input");
        input.id = id;
        input.type = "checkbox";
        div.appendChild(p);
        div.appendChild(input);

        value(input).then(() => {
            input.checked = onLoad;
        });

        input.onchange = () => {
            console.log("Saving " + id + " as " + input.checked);
            universal.save(id, input.checked);
            universal.sendToast("Saved changes!");
            onChanged(input.checked);
        };

        document.querySelector(goto).appendChild(div);
    }

    /**
     * Create a setting dynamically.
     * @param {String} name The name of the setting.
     * @param {String} id The ID of the setting.
     * @param {Function} value The option setter.
     * @param {*} onLoad Default.
     * @param {String} goto The CSS selector to append to.
     * @param {Function} onChanged The function to call when the setting changes.
     */
    function createSelectSetting(
        name,
        id,
        value,
        onLoad,
        goto,
        onChanged = () => { },
    ) {
        const div = document.createElement("div");
        div.className = "flex-wrap-r";
        const p = document.createElement("p");
        p.innerText = name;
        const select = document.createElement("select");
        select.id = id;
        div.appendChild(p);
        div.appendChild(select);

        value(select).then(() => {
            select.value = onLoad;
        });

        select.onchange = () => {
            console.log("Saving " + id + " as " + select.value);
            universal.save(id, select.value);
            universal.sendToast("Saved changes!");
            onChanged(select.value);
        };

        document.querySelector(goto).appendChild(div);
    }

    /**
     * Create a setting category.
     * @param {String} name The name of the category.
     * @param {String} goto The class (goto for other functions) to append to.
     * @param {Boolean} appendToIAS Append setting to in app settings
     */
    function createSettingCategory(name, goto, appendToIAS = false) {
        const appendTo = document.querySelector(".settings");
        const div = document.createElement("div");
        div.className = goto;
        appendTo.appendChild(div);
        const h2 = document.createElement("h2");
        h2.innerText = name;
        if (name.split("$(").length > 1) {
            const tag = document.createElement("span");
            tag.className = "tag";
            tag.innerText = name.split("$(")[1].split(")")[0];
            h2.appendChild(tag);
            name = name.split("$(")[0];
            h2.innerText = name;
        }
        div.appendChild(h2);
        appendTo.appendChild(div);
    }

    /**
     * Create a setting dynamically.
     * @param {*} name The name of the setting.
     * @param {*} id The ID of the setting.
     * @param {*} value The option setter.
     * @param {*} onLoad The default value.
     * @param {*} goto The CSS selector to append to.
     * @param {*} onChanged The function to call when the setting changes.
     */
    function createInputSetting(
        name,
        id,
        value,
        onLoad,
        goto,
        onChanged = () => { },
    ) {
        const div = document.createElement("div");
        div.className = "flex-wrap-r";
        const p = document.createElement("p");
        p.innerText = name;
        const input = document.createElement("input");
        input.id = id;
        div.appendChild(p);
        div.appendChild(input);

        value(input).then(() => {
            input.value = onLoad;
        });

        input.onchange = () => {
            console.log("Saving " + id + " as " + input.value);
            universal.save(id, input.value);
            universal.sendToast("Saved changes!");
            onChanged(input.value);
        };

        document.querySelector(goto).appendChild(div);
    }

    const setupWizard = () => {
        const sinks = {};
        const sources = {};
        navigator.mediaDevices.getUserMedia({ audio: true }).then(() => {
            navigator.mediaDevices.enumerateDevices().then((devices) => {
                devices.forEach((device) => {
                    if (device.kind == "audiooutput") {
                        if (!device.label.includes("Input"))
                            sinks[device.deviceId] = device.label;
                        if (device.label.includes("Input"))
                            sources[device.deviceId] = device.label;
                    }
                });
                showText(
                    "Setup Wizard",
                    "Welcome to the Freedeck setup wizard! This will help you set up Freedeck for the first time.",
                    () => {
                        showPick(
                            "Select a monitor device (where you will hear the sounds)",
                            Object.keys(sinks).map((data) => {
                                return {
                                    sink: data,
                                    name: sinks[data],
                                };
                            }),
                            (modal, data, feedback, title, button, content) => {
                                console.log("User selected " + data.name);
                                universal.save("monitor.sink", data.sink);
                                showPick(
                                    "Select your VB-Cable device (where you will play the sounds through)",
                                    Object.keys(sources).map((data) => {
                                        return {
                                            sink: data,
                                            name: sources[data],
                                        };
                                    }),
                                    (
                                        modal,
                                        data,
                                        feedback,
                                        title,
                                        button,
                                        content,
                                    ) => {
                                        console.log(
                                            "User selected " + data.name,
                                        );
                                        universal.save("vb.sink", data.sink);
                                        universal.save("pitch", 1);
                                        universal.save("vol", 1);
                                        showText(
                                            "All done!",
                                            "You're all set up! You can now use Freedeck.",
                                            () => {
                                                universal.sendToast(
                                                    "All done, reloading...",
                                                    "Setup complete!"
                                                );
                                                universal.save(
                                                    "has_setup",
                                                    true,
                                                );
                                                window.location.href =
                                                    "/companion/index.html?err=last-step";
                                            },
                                        );
                                    },
                                );
                            },
                        );
                    },
                );
            });
        });
    };

    window.st_run_setup = setupWizard;

    /**
     * Create a list picker modal.
     * @param {String} title The title of the modal
     * @param {Array} listContent The content of the list
     * @param {void} callback What to do when submitted
     */
    function showPick(title, listContent, callback) {
        const modal = document.createElement("div");
        modal.className = "modal";
        modal.style.position = "fixed";
        modal.style.top = "0";
        modal.style.left = "0";
        modal.style.width = "100vw";
        modal.style.height = "100vh";
        modal.style.background = "rgba(0,0,0,.75)";
        modal.style.zIndex = "9999";
        modal.style.display = "flex";
        modal.style.alignItems = "center";
        modal.style.justifyContent = "center";

        const modalContent = document.createElement("div");
        modalContent.className = "modalContent";

        const modalTitle = document.createElement("h2");
        modalTitle.innerText = title;
        modalTitle.style.marginBottom = "20px";
        modalContent.appendChild(modalTitle);

        const modalFeedback = document.createElement("div");
        modalFeedback.className = "modalFeedback";
        modalFeedback.style.color = "red";
        modalFeedback.style.marginBottom = "20px";
        modalContent.appendChild(modalFeedback);

        const modalList = document.createElement("select");
        modalList.className = "modalList";
        modalList.style.marginBottom = "20px";
        modalContent.appendChild(modalList);

        listContent.forEach((item) => {
            const modalItem = document.createElement("option");
            modalItem.className = "modalItem";
            modalItem.setAttribute("value", JSON.stringify(item));
            modalItem.innerText = item.name;
            modalList.appendChild(modalItem);
        });

        const modalButton = document.createElement("button");
        modalButton.innerText = "Save";
        modalButton.onclick = () => {
            const selectedItem = modalList.options[modalList.selectedIndex];
            const returned = callback(
                modal,
                JSON.parse(selectedItem.getAttribute("value")),
                modalFeedback,
                modalTitle,
                modalButton,
                modalContent,
            );
            if (returned === false) return;
            modal.remove();
        };
        modalContent.appendChild(modalButton);

        modal.appendChild(modalContent);

        document.body.appendChild(modal);
    }

    /**
     * Show text in a simple modal.
     * @param {String} title The title of the modal
     * @param {String} txt The text to show on the modal
     * @param {void} cb The callback to call when the modal is closed
     */
    function showText(title, txt, cb) {
        const modal = document.createElement("div");
        modal.className = "modal";

        const modalContent = document.createElement("div");
        modalContent.className = "modalContent";

        const modalTitle = document.createElement("h2");
        modalTitle.innerText = title;
        modalTitle.style.marginBottom = "20px";
        modalContent.appendChild(modalTitle);

        const modalFeedback = document.createElement("div");
        modalFeedback.className = "modalFeedback";
        modalFeedback.style.color = "red";
        modalFeedback.style.marginBottom = "20px";
        modalContent.appendChild(modalFeedback);

        const modalTxt = document.createElement("p");
        modalTxt.innerText = txt;
        modalTxt.style.marginBottom = "20px";
        modalContent.appendChild(modalTxt);

        const modalButton = document.createElement("button");
        modalButton.innerText = "OK";
        modalButton.onclick = () => {
            cb();
            modal.remove();
        };
        modalContent.appendChild(modalButton);

        modal.appendChild(modalContent);

        document.body.appendChild(modal);
    }

    const settingsHelpers = {
        createBooleanSetting,
        createSelectSetting,
        createSettingCategory,
        createInputSetting,
    };

    export { settingsHelpers };
    window.settingsHelpers = settingsHelpers;
    window.createSelectSetting = createSelectSetting;
    window.createInputSetting = createInputSetting;
    window.createSettingCategory = createSettingCategory;

    document.querySelector(".soundpack").style.display = universal.uiSounds
        .enabled()
        ? "block"
        : "none";
    document.querySelector("#soundpack-id").innerText =
        universal.uiSounds.info.id;
    document.querySelector("#soundpack-title").innerText =
        universal.uiSounds.info.name;
    document.querySelector("#soundpack-version").innerText =
        universal.uiSounds.info.version;
    document.querySelector("#soundpack-author").innerText =
        universal.uiSounds.info.author;

    function loadSounds() {
        const uis = document.querySelector(".uisounds");
        uis.innerHTML = "";
        console.log(universal.uiSounds.sounds);
        const uisounds = universal.uiSounds.sounds;
        Object.keys(uisounds).forEach((sound) => {
            const li = document.createElement("li");
            li.innerText = sound;
            li.onclick = () => {
                universal.uiSounds.playSound(sound);
            };
            uis.appendChild(li);
        });
    }

    universal._information.soundpacks.forEach((soundpack) => {
        const li = document.createElement("li");
        li.innerText = soundpack.split(".soundpack")[0];
        li.classList.add("soundpack");
        li.onclick = async () => {
            document.querySelector("#soundpack-id").innerText = "LOADING";
            document.querySelector("#soundpack-title").innerText = "LOADING";
            document.querySelector("#soundpack-version").innerText = "LOADING";
            document.querySelector("#soundpack-author").innerText = "LOADING";
            document.querySelectorAll(".soundpack").forEach((el) => {
                el.disabled = true;
            });
            const res = await fetch(
                "/common/sounds/" + soundpack + "/manifest.fdsp.json",
            );
            const data = await res.json();
            const info = data.info;
            universal.save("soundpack", info.id);
            universal.uiSounds.reload();
            universal.uiSounds.load(info.id).then(() => {
                loadSounds();
            });
            document.querySelector("#soundpack-id").innerText = info.id;
            document.querySelector("#soundpack-title").innerText = info.name;
            document.querySelector("#soundpack-version").innerText =
                info.version;
            document.querySelector("#soundpack-author").innerText = info.author;
            document.querySelectorAll(".soundpack").forEach((el) => {
                el.disabled = false;
            });
        };
        document.querySelector(".soundpacks").appendChild(li);
    });

    loadSounds();
</script>